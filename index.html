<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JahanCraft Server</title>

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b0f1a;
  --card:#121a2b;
  --accent:#6c5cff;
  --accent2:#00e0ff;
  --text:#fff;
}

body{margin:0;font-family:'Vazirmatn',sans-serif;background:radial-gradient(circle at 20% 20%,#1a1f3d,#05070f);color:var(--text);}

/* HEADER */
header{position:sticky;top:0;backdrop-filter:blur(20px);background:rgba(10,15,30,.6);display:flex;align-items:center;justify-content:space-between;padding:14px 40px;z-index:100;}
.logoBox{display:flex;align-items:center;gap:12px;cursor:pointer;}
.logoBox img{width:48px;height:48px;border-radius:12px;object-fit:cover;}
nav a{margin:0 16px;text-decoration:none;color:#cfd8ff;font-weight:600;}
nav a:hover{color:white}
.userBox{position:relative;cursor:pointer;font-weight:700;}
.userDropdown{position:absolute;top:40px;left:0;background:#11182b;padding:10px;border-radius:10px;display:none;min-width:140px;box-shadow:0 10px 30px rgba(0,0,0,.5);}
.userDropdown button{width:100%;background:none;border:none;color:white;padding:8px;cursor:pointer;}
.userBox.open .userDropdown{display:block}
#loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#05070f;font-size:22px;z-index:999;display:none;}
.hero{padding:80px 20px 40px;text-align:center;}
.serverIP{margin-top:20px;display:inline-block;padding:14px 26px;border-radius:14px;background:linear-gradient(90deg,var(--accent),var(--accent2));font-weight:800;letter-spacing:1px;}
.newsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px;padding:40px;}
.newsCard{background:var(--card);border-radius:18px;overflow:hidden;cursor:pointer;transition:.3s;display:flex;flex-direction:column;}
.newsCard:hover{transform:translateY(-6px);}
.newsCard img{width:100%;aspect-ratio:1/1;object-fit:cover;}
.newsCard .content{padding:18px;}
.newsCard h3{margin:0 0 10px;}
.fullNews{max-width:900px;margin:60px auto;padding:0 20px;}
.fullNews img{max-width:100%;border-radius:14px;margin:20px 0;}
.fullNews .headerImg{width:100%;max-height:420px;object-fit:cover;border-radius:16px;}
</style>
</head>
<body>

<div id="loading">در حال بارگذاری...</div>

<header>
<div class="logoBox" onclick="goHome()">
<img src="LOGO_URL_HERE" />
<strong>JahanCraft</strong>
</div>
<nav>
<a onclick="goHome()">خانه</a>
<a onclick="loadNewsPage()">اخبار</a>
</nav>
<div id="authArea"></div>
</header>

<section id="app"></section>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://jlowxwiopeeltlnndhdb.supabase.co"; // جای URL پروژه
const SUPABASE_KEY = "sb_publishable_dDDf6D2FjEzv6XtryAMwuw_-jNoRELe"; // جای ANON KEY

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= GLOBAL ================= */
let currentUser = JSON.parse(localStorage.getItem("user") || "null");

/* ================= LOADING ================= */
function showLoading(state){
  document.getElementById("loading").style.display = state?"flex":"none";
}

/* ================= AUTH ================= */
function renderAuth(){
  const box=document.getElementById("authArea");
  if(!currentUser){
    box.innerHTML=`<button onclick="showLogin()">ورود</button>`;
    return;
  }
  box.innerHTML=`
  <div class="userBox" onclick="toggleUserMenu(this)">
    ${currentUser.real_name}
    <div class="userDropdown">
      <button onclick="logout()">خروج</button>
    </div>
  </div>`;
}

function toggleUserMenu(el){el.classList.toggle("open");}
function logout(){localStorage.removeItem("user"); currentUser=null; renderAuth(); goHome();}

/* ================= NAV ================= */
function goHome(){loadHome();}

/* ================= HOME ================= */
async function loadHome(){
  showLoading(true);
  try{
    const {data,error} = await supabase.from("news").select("*").order("id",{ascending:false}).limit(3);
    const app=document.getElementById("app");
    if(error){console.log(error); app.innerHTML="<p>خطا در دریافت اخبار</p>"; return;}
    const newsData = data || [];
    app.innerHTML=`
      <div class="hero">
        <h1>سرور جهان کرفت</h1>
        <div class="serverIP">play.jahancraft.ir</div>
      </div>
      <div class="newsGrid">
        ${newsData.map(n=>newsCardHTML(n)).join("")}
      </div>
    `;
  }catch(e){console.log(e);}
  finally{showLoading(false);}
}

/* ================= NEWS PAGE ================= */
async function loadNewsPage(){
  showLoading(true);
  try{
    const {data,error} = await supabase.from("news").select("*").order("id",{ascending:false});
    const app=document.getElementById("app");
    if(error){console.log(error); app.innerHTML="<p>خطا در دریافت اخبار</p>"; return;}
    const newsData = data || [];
    app.innerHTML=`
      <h2 style="padding:30px">اخبار سرور</h2>
      <div class="newsGrid">
        ${newsData.map(n=>newsCardHTML(n)).join("")}
      </div>
    `;
  }catch(e){console.log(e);}
  finally{showLoading(false);}
}

function newsCardHTML(n){
  return `
    <div class="newsCard" onclick="openNews(${n.id})">
      <img src="${n.image_url}" />
      <div class="content">
        <h3>${n.title}</h3>
      </div>
    </div>`;
}

/* ================= FULL NEWS ================= */
async function openNews(id){
  showLoading(true);
  try{
    const {data,error} = await supabase.from("news").select("*").eq("id",id).single();
    const app=document.getElementById("app");
    if(error){console.log(error); app.innerHTML="<p>خطا در باز کردن خبر</p>"; return;}
    const news = data || {};
    app.innerHTML=`
      <div class="fullNews">
        <img class="headerImg" src="${news.image_url}" />
        <h1>${news.title}</h1>
        <div>${news.content}</div>
      </div>`;
  }catch(e){console.log(e);}
  finally{showLoading(false);}
}

/* ================= LOGIN ================= */
function showLogin(){
  const app=document.getElementById("app");
  app.innerHTML=`
    <h2>ورود</h2>
    <input id="u" placeholder="username"><br><br>
    <input id="p" type="password" placeholder="password"><br><br>
    <button onclick="login()">ورود</button>
  `;
}

async function login(){
  const username=document.getElementById("u").value;
  const password=document.getElementById("p").value;
  showLoading(true);
  try{
    const {data,error} = await supabase.from("users").select("*").eq("username",username).eq("password",password).single();
    if(error || !data){alert("اطلاعات اشتباه است"); return;}
    localStorage.setItem("user",JSON.stringify(data));
    currentUser=data;
    renderAuth();
    goHome();
  }catch(e){console.log(e);}
  finally{showLoading(false);}
}

/* ================= INIT ================= */
renderAuth();
goHome();
</script>
</body>
</html>
